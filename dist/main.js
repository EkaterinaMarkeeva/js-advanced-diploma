!function(){"use strict";function t(t,e){if(t<0||t>=e**2)throw new Error("Вне поля");if(0===t)return"top-left";if(t===e-1)return"top-right";if(t===e**2-1)return"bottom-right";if(t===e*(e-1))return"bottom-left";if(t<e)return"top";if(t>e*(e-1)&&t<e**2-1)return"bottom";for(let a=1;a<e-1;a+=1)if(t===e*a)return"left";for(let a=2;a<e;a+=1)if(t===e*a-1)return"right";return"center"}class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${t(e,this.boardSize)}`),a.addEventListener("mouseenter",(t=>this.onCellEnter(t))),a.addEventListener("mouseleave",(t=>this.onCellLeave(t))),a.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const a of t){const t=this.boardEl.children[a.position],i=document.createElement("div");i.classList.add("character",a.character.type);const s=document.createElement("div");s.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=a.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${a.character.health}%`,s.appendChild(r),i.appendChild(s),t.appendChild(i)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((a=>{const i=this.cells[t],s=document.createElement("span");s.textContent=e,s.classList.add("damage"),i.appendChild(s),s.addEventListener("animationend",(()=>{i.removeChild(s),a()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}removeAllListeners(){this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}}const a={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};function i(){return Object.keys(a)}class s{constructor(t){this.characters=[...t]}}function*r(t,e){const a=c(1,e),i=new(t[c(0,t.length-1)])(a);yield i}function o(t,e,a){const i=[];for(let s=0;s<a;s+=1){const a=r(t,e);i.push(a.next().value)}return new s(i)}function c(t,e){return Math.floor(Math.random()*(e-t+1))+t}class n{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if("Character"===new.target.name)throw new Error("Невозможно создать персонажа");if(t>4||t<1)throw new Error("Уровень должно быть не менее 1 и не более 4");this.level=t,this.attack=0,this.defence=0,this.health=50,this.type=e,this.radiusAttack=0,this.radiusMotion=0}getDamage(t){return Math.max(this.attack-t.defence,.1*this.attack)}}class h{constructor(t,e){if(!(t instanceof n))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}determiningRadiusAttack(t,e){return this.determiningRadius(t,e,this.character.radiusAttack)}determiningRadiusMotion(t,e){return this.determiningRadius(t,e,this.character.radiusMotion)}determiningRadius(t,e,a){const i=this.position,s=i%e,r=Math.floor(i/e),o=t%e,c=Math.floor(t/e),n=Math.abs(r-c),h=Math.abs(s-o);return r===c&&h<=a||s===o&&n<=a||n<=a&&h<=a&&n===h||void 0}}var l={bowman:class extends n{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bowman"),t>1?(this.attack=25*t,this.defence=25*t):(this.attack=25,this.defence=25),this.radiusAttack=2,this.radiusMotion=2}},daemon:class extends n{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"daemon"),t>1?(this.attack=10*t,this.defence=10*t):(this.attack=10,this.defence=10),this.radiusAttack=4,this.radiusMotion=1}},magician:class extends n{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"magician"),t>1?(this.attack=10*t,this.defence=40*t):(this.attack=10,this.defence=40),this.radiusAttack=4,this.radiusMotion=1}},swordsman:class extends n{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"swordsman"),t>1?(this.attack=40*t,this.defence=10*t):(this.attack=40,this.defence=10),this.radiusAttack=1,this.radiusMotion=4}},undead:class extends n{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"undead"),t>1?(this.attack=40*t,this.defence=10*t):(this.attack=40,this.defence=10),this.radiusAttack=1,this.radiusMotion=4}},vampire:class extends n{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"vampire"),t>1?(this.attack=25*t,this.defence=25*t):(this.attack=25,this.defence=25),this.radiusAttack=2,this.radiusMotion=2}}},d="auto",m="pointer",v="crosshair",u="not-allowed";class p{constructor(){this.motion=0,this.lvlGame=0,this.victory=0,this.defeat=0,this.positionedCharacters=[],this.pointerActiveLocked=!1}static from(t){return t?{motion:t.motion,lvlGame:t.lvlGame,positionedCharacters:t.positionedCharacters,pointerActiveLocked:t.pointerActiveLocked,victory:t.victory,defeat:t.defeat}:null}}const C=new e;C.bindToDOM(document.querySelector("#game-container"));const g=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),f=new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.activeCharacter=null,this.state=new p}init(){this.gamePlay.drawUi(i()[0]),this.registrationEvents();const t=o([l.bowman,l.swordsman,l.magician],1,2),e=o([l.daemon,l.undead,l.vampire],1,2);this.creatChars(t,e,[]),this.gamePlay.redrawPositions(this.state.positionedCharacters)}creatChars(t,e,a){function i(t,e,a,i,s,r){let o,n=0;for(;(!o||r.includes(o))&&n<1e3;)o=c(t,e)*s+c(a,i),n+=1;return o}t.characters.forEach((t=>{const e=i(0,this.gamePlay.boardSize-1,0,1,this.gamePlay.boardSize,a),s=new h(t,e);s.isPlayer=!0,s.condition="live",this.state.positionedCharacters.push(s),a.push(e)})),e.characters.forEach((t=>{const e=i(0,this.gamePlay.boardSize-1,this.gamePlay.boardSize-2,this.gamePlay.boardSize-1,this.gamePlay.boardSize,a),s=new h(t,e);s.isPlayer=!1,s.condition="live",this.state.positionedCharacters.push(s),a.push(e)}))}lvlUpGame(t){this.state.lvlGame+=1,this.activeCharacter=null,this.state.motion=0,this.gamePlay.drawUi(i()[this.state.lvlGame]);const e=o([l.bowman,l.swordsman,l.magician],this.state.lvlGame+1,t-this.state.positionedCharacters.length),a=o([l.daemon,l.undead,l.vampire],this.state.lvlGame+1,t);this.state.positionedCharacters.forEach((t=>{if("live"===t.condition){const e=t.character.attack,a=t.character.defence;t.character.level+=1,t.character.attack=Math.ceil(Math.max(e,e*(80+t.character.health)/100)),t.character.defence=Math.ceil(Math.max(a,a*(80+t.character.health)/100)),t.character.health+80>100?t.character.health=100:t.character.health+=80}else t.character.health=50})),this.state.positionedCharacters.forEach((t=>{e.characters.push(t.character)})),this.state.positionedCharacters=[],this.creatChars(e,a,[]),this.gamePlay.redrawPositions(this.state.positionedCharacters)}newGame(){this.activeCharacter=null,this.state=new p,this.init()}onSaveGameListener(){this.stateService.save(this.state)}onLoadGameListener(){const t=p.from(this.stateService.load());for(let e in this.state)this.state[e]=t[e];this.state.positionedCharacters=this.state.positionedCharacters.map((t=>{const e=new l[t.character.type](t.character.level);e.attack=t.character.attack,e.defence=t.character.defence,e.health=t.character.health;const a=new h(e,t.position);return a.isPlayer=t.isPlayer,a.condition=t.condition,a})),this.activeCharacter=null,this.gamePlay.drawUi(i()[this.state.lvlGame]),this.gamePlay.redrawPositions(this.state.positionedCharacters.filter((t=>"dead"!==t.condition)))}registrationEvents(){this.removeEvents(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameListener.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameListener.bind(this))}removeEvents(){this.gamePlay.removeAllListeners()}onCellClick(t){if(this.state.pointerActiveLocked)return;const a=this.gamePlay.cells[t].querySelector(".character");this.state.motion%2==0&&a&&!this.activeCharacter?this.state.positionedCharacters.forEach((a=>{a.position!==t||a.isPlayer?a.position===t&&a.isPlayer&&this.gamePlay.cells.forEach(((e,i)=>{e.className.indexOf("selected-yellow")>-1?this.gamePlay.deselectCell(i):this.setActiveCharacter(a,t)})):e.showError("Персонаж недоступен")})):this.state.motion%2==0&&a&&this.activeCharacter?this.state.positionedCharacters.forEach((e=>{if(e.position===t&&!e.isPlayer&&this.activeCharacter.determiningRadiusAttack(t,this.gamePlay.boardSize)){const a=this.activeCharacter.character.getDamage(e.character);e.character.health-a>0?e.character.health=e.character.health-a:this.state.positionedCharacters=this.state.positionedCharacters.filter((t=>t.position!==e.position)),this.gamePlay.showDamage(t,a).then((()=>{this.gamePlay.deselectCell(this.activeCharacter.position),this.removSelected(t,this.state.positionedCharacters.filter((t=>"dead"!==t.condition)))}))}else e.position===t&&e.isPlayer&&this.gamePlay.cells.forEach(((a,i)=>{a.className.indexOf("selected-yellow")>-1?this.gamePlay.deselectCell(i):this.setActiveCharacter(e,t)}))})):this.state.motion%2==0&&this.activeCharacter&&this.activeCharacter.determiningRadiusMotion(t,this.gamePlay.boardSize)&&(this.state.positionedCharacters.forEach((e=>{e.position===this.activeCharacter.position&&(this.gamePlay.deselectCell(this.activeCharacter.position),e.position=t)})),this.removSelected(t,this.state.positionedCharacters.filter((t=>"dead"!==t.condition))))}onCellEnter(t){if(this.state.pointerActiveLocked)return;const e=this.gamePlay.cells[t].querySelector(".character");let a;this.state.motion%2==0&&e?(this.state.positionedCharacters.forEach((e=>{e.position===t&&(a=this.getMessage(e.character),!e.isPlayer&&this.activeCharacter?this.activeCharacter.determiningRadiusAttack(t,this.gamePlay.boardSize)?(this.gamePlay.selectCell(t,"red"),this.gamePlay.setCursor(v)):this.gamePlay.setCursor(u):this.activeCharacter||(this.gamePlay.setCursor(d),this.gamePlay.deselectCell(t)))})),this.gamePlay.showCellTooltip(a,t)):this.state.motion%2==0&&this.activeCharacter?this.activeCharacter.determiningRadiusMotion(t,this.gamePlay.boardSize)?this.gamePlay.selectCell(t,"green"):this.gamePlay.setCursor(u):this.activeCharacter||(this.gamePlay.setCursor(d),this.gamePlay.deselectCell(t))}onCellLeave(t){this.state.pointerActiveLocked||(this.gamePlay.hideCellTooltip(t),this.gamePlay.setCursor(m),this.gamePlay.cells[t].classList.remove("selected-green"),this.gamePlay.cells[t].classList.remove("selected-red"))}setActiveCharacter(t,e){this.activeCharacter=t,this.gamePlay.selectCell(e)}removSelected(t,e){this.gamePlay.redrawPositions(e),this.onCellLeave(t),this.state.motion+=1,this.activeCharacter=null,this.state.motion%2!=0&&this.goOpponent()}getMessage(t){return`🎖 ${t.level} ⚔ ${t.attack} 🛡 ${t.defence} ❤ ${t.health}`}goOpponent(){let t=[],e=[],a=!1,i={},s=[];this.state.positionedCharacters.forEach((t=>{s.push(t.position)})),this.state.positionedCharacters.forEach((a=>{a.isPlayer?"live"===a.condition&&e.push(a):t.push(a)})),0===t.length&&(0===this.state.lvlGame?(this.state.victory+=1,this.lvlUpGame(3)):3===this.state.lvlGame?(this.state.victory+=1,this.state.pointerActiveLocked=!0):(this.state.victory+=1,this.lvlUpGame(5))),t.sort(((t,e)=>e.character.level-t.character.level)),e.sort(((t,e)=>e.character.level-t.character.level)),t.forEach(((t,e)=>{i[e]=[];for(let a=0;a<this.gamePlay.boardSize**2;a+=1)t.determiningRadiusMotion(a,this.gamePlay.boardSize)&&!s.includes(a)&&a!==t.position&&i[e].push(a)})),t.forEach((t=>{e.forEach((i=>{if(!a&&t.determiningRadiusAttack(i.position,this.gamePlay.boardSize)){a=!0,this.activeCharacter=t,this.gamePlay.selectCell(this.activeCharacter.position),this.gamePlay.selectCell(i.position,"red");const s=this.activeCharacter.character.getDamage(i.character);i.character.health-s>0?i.character.health=i.character.health-s:(this.state.positionedCharacters.forEach((t=>{t.position===i.position&&(t.condition="dead")})),e=e.filter((t=>t.position!==i.position))),this.gamePlay.showDamage(i.position,s).then((()=>{this.gamePlay.deselectCell(this.activeCharacter.position),this.gamePlay.deselectCell(i.position),this.removSelected(this.activeCharacter.position,this.state.positionedCharacters.filter((t=>"dead"!==t.condition)))})),0===e.length&&(this.state.pointerActiveLocked=!0,this.state.defeat+=1)}}))})),a||t.forEach(((s,r)=>{i[r].forEach((r=>{e.forEach((o=>{if(a)return;const n=s.position;if(s.position=r,s.determiningRadiusAttack(o.position,this.gamePlay.boardSize))a=!0,this.gamePlay.selectCell(r,"green"),s.position=n,this.activeCharacter=s,this.gamePlay.selectCell(this.activeCharacter.position),this.activeCharacter.position=r,this.gamePlay.deselectCell(this.activeCharacter.position),this.gamePlay.deselectCell(n),this.removSelected(r,this.state.positionedCharacters.filter((t=>"dead"!==t.condition))),0===e.length&&(this.state.pointerActiveLocked=!0,this.state.defeat+=1);else{a=!0,s.position=n;let r=c(0,t.length-1),o=c(0,i[r].length-1),h=i[r][o];this.activeCharacter=t[r],this.gamePlay.selectCell(this.activeCharacter.position),this.gamePlay.selectCell(h,"green"),this.state.positionedCharacters.forEach((t=>{t.position===this.activeCharacter.position&&(this.gamePlay.deselectCell(this.activeCharacter.position),this.gamePlay.deselectCell(h),t.position=h)})),this.removSelected(h,this.state.positionedCharacters.filter((t=>"dead"!==t.condition))),0===e.length&&(this.state.pointerActiveLocked=!0,this.state.defeat+=1)}}))}))}))}}(C,g);f.init()}();